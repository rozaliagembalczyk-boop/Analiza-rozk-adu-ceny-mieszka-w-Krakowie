#install.packages("openxlsx")
library(ggplot2) #to na pewno się przyda
library(openxlsx)
library(Hmisc)
dane = read.xlsx("C://Users//Rozalka//Desktop//mieszkania8.xlsx", sheet=1)
head(dane)
dane$dzielnica = as.factor(dane$dzielnica)
dane$pietro = as.factor(dane$pietro)
dane$parking = as.factor(dane$parking)
dane$winda = as.factor(dane$winda)

summary(dane)
# Zmiennymi jakościowymi są dzielnica, pietro, parking oraz winda. Zmiennymi ilościowymi są odleglosc_od_sklepu, cena, powierzchnia, l_pokoi oraz odleglosc_od_przystanku. 

tab_licz1 = table(dane$pietro)
d1 = names(which.max(tab_licz1))

tab_licz2 = table(dane$parking)
d2 = names(which.max(tab_licz2))

tab_licz3 = table(dane$winda)
d3 = names(which.max(tab_licz3))

dane$cena = impute(dane$cena, fun=mean)
dane$powierzchnia = impute(dane$powierzchnia, fun=mean)
dane$l_pokoi  = impute(dane$l_pokoi , fun=mean)
dane$odleglosc_od_przystanku = impute(dane$odleglosc_od_przystanku, fun=mean)
dane$odleglosc_od_sklepu = impute(dane$odleglosc_od_sklepu, fun=mean)
dane$pietro = impute(dane$pietro, d1)
dane$parking = impute(dane$parking, d2)
dane$winda = impute(dane$winda, d3)


dane$dzielnica = as.factor(dane$dzielnica)
dane$pietro = as.factor(dane$pietro)
dane$parking = as.factor(dane$parking)
dane$winda = as.factor(dane$winda)

dane$cena = as.numeric(dane$cena)
dane$powierzchnia = as.numeric(dane$powierzchnia)
dane$l_pokoi = as.numeric(dane$l_pokoi)
dane$odleglosc_od_przystanku = as.numeric(dane$odleglosc_od_przystanku)
summary(dane)


ggplot(dane, aes(x= dzielnica, fill = winda))+
  geom_bar(position="dodge")+
  scale_fill_manual(
    values = c("0" = "#7AA5EE", "1" = "#6F0148"),
    labels = c("Brak windy", "Jest winda")
  ) +
  labs(title = "Liczba ofert w dzielnicach z podziałem na status windy",
    x = "Dzielnica",
    y = "Liczba ofert",
    fill = "Winda (0-brak, 1-jest)")+
  theme(
    panel.background = element_rect(fill="white"),
    panel.border = element_rect(color = "black", size = 0.2, fill = NA),  
    panel.grid.major = element_line(color = "grey", size = 0.2),  
    panel.grid.minor = element_line(color = "grey", size = 0.25)
  )

# We wszytskich dzielnicach występuje znacząca przewaga mieszkań z windą. Najwięcej mieszkań występuje w dzielnicy Dębniki, jest też tam najwięcej mieszkań z windą (blisko 500). Najmniejsza liczba mieszkań występuje w dzielnicy Prądnik Biały, jest też tam najmniejsza liczba mieszkań z windą (około 70). Najwięcej mieszkań bez widny znajduje się w dzielnicy Dębniki (blisko 100), a najmniej w dzielnicy Prądnik Biały (około 10).Dzielnice Bronowice i Nowa Huta mają zbliżone wartości mieszkań z windą i mieszkań bez windy. Najwięcej mieszkań bez windy w stosunku do mieszkań z windą jest w dzielnicy Stare Miasto, co prawdopodobnie wynika z starej zabudowy charakteryzującej się brakiem wind. W Dębnikach i Bronowicach przewaga ofert z windą jest największa, co może sugerować istnienie nowszych osiedli mieszkaniowych. 
Podsumowując, niezależnie od lokalizacji winda stała się waznym aspektem budownictwa. Największy wybór mieszkań (niezależnie od standardu) znajduje się w Dębnikach, natomiast najtrudniej o mieszkanie bez windy jest w Prądniku Białym.

mean_price = mean(dane$cena)
median_price = median(dane$cena)
#plot(density(dane$cena))
hist(dane$cena, main="Rozkład cen mieszkań", xlab="Cena mieszkania w PLN", ylab="Gęstość", col="#CCD3EE", , probability=TRUE)
lines(density(dane$cena))
abline(v = mean_price, col = "#eb3434", lwd = 2, lty = 2)
abline(v = median_price, col = "#3CA158", lwd = 2, lty = 2)
legend("topright", 
       legend = c("Średnia", "Mediana"),
       col = c("#eb3434", "#3CA158"),
       lwd = 2, 
       lty = 2)

skewness(dane$cena)
kurtosis(dane$cena)

# Jest to rozkład asymetryczny, prawoskośny z ogonem wyciągniętym w prawo i średnią większą niż mediana.Jest to niesymetryczny rozkład bimodalny, czyli posiadający dwie mody: jedną dla watości około 500 000 zł, drugą dla wartości ponad 1 000 000 zł. 

ggplot(dane, aes( y=powierzchnia, color=parking))+
  geom_boxplot()+
  labs(title="Wykresy pudełkowe dla powierzchni mieszkania z podziałem kolorem na \nstatus parkingu (jest czy nie ma) oraz z podziałem na osobne panele ze \nwzględu na piętro", x="piętro i parking (0 – brak miejsca postojowego lub parkingu, 1 – jest miejsce postojowe lub parking) ", y="powierzchnia mieszkania")+
  facet_grid(~pietro, labeller=label_both)


n_dzielnica = names(which.max(table(dane$dzielnica)))
ceny_n = dane$cena[dane$dzielnica == n_dzielnica]
value = ceny_n
#hist(value, breaks = 30)
descdist(value, discrete = FALSE) 

normalize <- function(x) {
  return((x - min(x)) / (max(x) - min(x)))
}

normalized_value <- normalize(value)
normalized_value[normalized_value==0]=0.00001
normalized_value[normalized_value==1]=0.99999

fit_beta <- fitdist(normalized_value, "beta")
plot(fit_beta) 
fit_unif <- fitdist(normalized_value, "unif")
plot(fit_unif) 
fit_norm <- fitdist(normalized_value, "norm")
plot(fit_norm)

gof_results1 <- gofstat(list(fit_beta, fit_unif), fitnames = c("Beta", "Jedostajny"))
gof_results2 <- gofstat(list(fit_beta, fit_norm), fitnames = c( "Beta", "Normalny"))
print(gof_results1)
print(gof_results2)

# Analizując wykres Cullen and Frey można stwierdzić, że najbardziej pasującym rozkładem będzie rozkład beta albo rozkład jednostajny. Po dokładniejszej analizie za pomocą Goodness-of-fit statistics i obliczonych tam wartości różnych statystyk dochodzimy do wniosku, że najlepszym dopasowaniem będzie rozkład beta, ponieważ wartości statystyk dla niego są niższe niż dla inncyh rozkładów. Potwierdzają to też wykresy QQplot, na których widać, że rozkład beta jest najbardziej zbliżony do rozkładu danych. 

model_dane = lm(cena ~ powierzchnia + odleglosc_od_sklepu+odleglosc_od_przystanku, data=dane)
summary(model_dane)

par(mfrow=c(2,2))
plot(model_dane)

bptest(model_dane)
durbinWatsonTest(model_dane)
shapiro.test(model_dane$residuals)

Wszystkie zmienne w modelu są statystycznie istotne, ponoeważ dla każdej z nich p-wartości wynosi mniej niż 0.05. Multiple R-squared:  0.8869, czyli model jest bardzo dobrze dopasowany (wyjaśnia 88,7% zmienności cen mieszkań). p-wartośc w F-statystyce < 2.2e-16, zatem wnioskujemy, że model jest statystycznie istotny. 

Z testu Breusch-Pagan wynika, że Breusch-Pagan test, co oznacza, że jest mniejsza od przyjętej wartości p=0.05, czyli odrzucamy hipotezę, że wariancja jest jednorodna. Z testu Durbina-watsona mamy rho!=0 i p-wartość równą 0.898 oraz statystykę D-W bliską 2, zatem W modelu nie występuje istotna statystycznie autokorelacja dodatnia oraz dane spełniają założenie o niezależności błędów. Z testów Shapiro-Wilk wnioskujemy, że błedy są niezależne i rozkład błędów odbiega od rozkładu normalnego. 

Z wykresów diagnostycznych można wywnioskować następujące rzeczy:
*Residuals vs Fitted: czerwona linia nie jest idealnie prosta i równa 0, dlatego założenie o liniowości i stałej wariancji nie jest całkowicie spełnione,
*Q-Q Residuals: reszty nie mają rozkładu normalnego (widac to przy wysokich wartościach), zatem przy wyższych cenach mieszkań model może popełniać błędy,
*Scale-Location: wynika z tego, że przeciętna wartość błędu rośnie wraz z ceną mieszkania (brak jednorodności wariancji),
*Residuals vs Leverage: występują wartości nietypowe, ale nie wpływają znacząco na model.

Model jest zatem istotny, ale przy wyższych cenach mieszkań wykazuje pewne błędy (ceny powyżej 1 000 000 zł).
